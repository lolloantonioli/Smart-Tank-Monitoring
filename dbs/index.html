<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Tank Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { background-color: #f8f9fa; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border: none; }
        .card-header { font-weight: bold; }
        
        /* Badge stati */
        .status-badge { 
            font-size: 1.5em; padding: 15px; border-radius: 8px; 
            color: white; text-align: center; font-weight: bold; 
            text-transform: uppercase; letter-spacing: 1px;
        }
        .bg-auto { background-color: #28a745; box-shadow: 0 0 10px #28a745; }
        .bg-manual { background-color: #ffc107; color: #333; box-shadow: 0 0 10px #ffc107; }
        .bg-unconnected { background-color: #dc3545; animation: pulse 2s infinite; }
        .bg-not-avail { background-color: #343a40; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        /* Slider personalizzato */
        input[type=range] { height: 30px; }
        input[type=range]:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="text-center mb-5">
        <h1>üíß Smart Tank Monitoring</h1>
        <p class="text-muted">Assignment #03 - Dashboard Subsystem</p>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="text-center text-muted mb-3">Stato Attuale del Sistema</h5>
                    <div id="system-state-badge" class="status-badge bg-not-avail">
                        CONNESSIONE IN CORSO...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    ‚öôÔ∏è Control Unit (WCS)
                </div>
                <div class="card-body d-flex flex-column justify-content-between">
                    
                    <div class="mb-4 text-center">
                        <label class="form-label text-muted">Modalit√† Operativa</label>
                        <button id="btn-switch-mode" class="btn btn-outline-secondary w-100 py-2 fw-bold" onclick="toggleMode()">
                            ...
                        </button>
                    </div>

                    <hr>

                    <div class="mb-2 text-center">
                        <label class="form-label text-muted">Apertura Valvola</label>
                        <h1 class="display-4 text-primary fw-bold mb-0">
                            <span id="valve-value">0</span><span style="font-size: 0.5em">%</span>
                        </h1>
                        
                        <div class="mt-3">
                            <input type="range" class="form-range" id="valve-slider" min="0" max="100" step="5" disabled 
                                   onchange="updateValve(this.value)" oninput="document.getElementById('valve-value').innerText = this.value">
                            <small id="slider-help" class="text-muted d-block mt-2">
                                Abilita MANUAL per controllare
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    üåä Livello Acqua (TMS)
                </div>
                <div class="card-body">
                    <canvas id="levelChart" style="max-height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURAZIONE ---
    // Soglie visuali (devono matchare quelle in CUS.java)
    const LEVEL_L1 = 60.0;
    const LEVEL_L2 = 85.0;
    const MAX_HISTORY = 30; // Numero di punti nel grafico

    // --- CHART.JS SETUP ---
    const ctx = document.getElementById('levelChart').getContext('2d');
    
    // Plugin per disegnare le linee di soglia L1 e L2
    const thresholdLines = {
        id: 'thresholdLines',
        beforeDraw: (chart) => {
            const { ctx, chartArea: { top, bottom, left, right }, scales: { y } } = chart;
            const drawLine = (value, color, label) => {
                const yPos = y.getPixelForValue(value);
                ctx.save();
                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.moveTo(left, yPos);
                ctx.lineTo(right, yPos);
                ctx.stroke();
                ctx.fillStyle = color;
                ctx.fillText(label, right - 30, yPos - 5);
                ctx.restore();
            };
            drawLine(LEVEL_L1, '#ffc107', 'L1 (Alert)');
            drawLine(LEVEL_L2, '#dc3545', 'L2 (Alarm)');
        }
    };

    const levelChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [], 
            datasets: [{
                label: 'Livello (cm)',
                data: [],
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { 
                y: { 
                    beginAtZero: true, 
                    suggestedMax: 100,
                    title: { display: true, text: 'Centimetri' }
                },
                x: { display: false } // Nascondiamo le label temporali per pulizia
            },
            animation: false, // Disabilita animazioni per performance real-time
            plugins: { legend: { display: false } }
        },
        plugins: [thresholdLines]
    });

    // --- LOGICA APPLICAZIONE ---
    const badge = document.getElementById('system-state-badge');
    const btnMode = document.getElementById('btn-switch-mode');
    const slider = document.getElementById('valve-slider');
    const valveLabel = document.getElementById('valve-value');
    const sliderHelp = document.getElementById('slider-help');

    // Funzione principale di aggiornamento (Polling ogni 500ms)
    async function fetchData() {
        try {
            const response = await fetch('/api/data');
            if (!response.ok) throw new Error("API Error");
            
            const data = await response.json();
            updateInterface(data);
        } catch (error) {
            setUnavailable();
        }
    }

    function updateInterface(data) {
        // 1. Stato Sistema
        let mode = data.mode || "NOT AVAILABLE";
        badge.innerText = mode;
        badge.className = "status-badge"; // Reset classi
        
        if (mode === 'AUTOMATIC') {
            badge.classList.add('bg-auto');
            btnMode.innerText = "Passa a MANUAL";
            btnMode.className = "btn btn-outline-warning w-100 py-2 fw-bold";
            disableControls(true);
        } else if (mode === 'MANUAL') {
            badge.classList.add('bg-manual');
            btnMode.innerText = "Passa a AUTOMATIC";
            btnMode.className = "btn btn-outline-success w-100 py-2 fw-bold";
            disableControls(false);
        } else if (mode === 'UNCONNECTED') {
            badge.classList.add('bg-unconnected');
            badge.innerText = "‚ö†Ô∏è UNCONNECTED (TMS LOST)";
            disableControls(true);
        } else {
            setUnavailable();
            return;
        }

        // 2. Valvola (Aggiorna solo se l'utente non sta trascinando lo slider)
        // 'mode === MANUAL' √® l'unico caso in cui l'utente comanda.
        // Se √® AUTOMATIC, aggiorniamo sempre visualmente.
        if (document.activeElement !== slider) {
            slider.value = data.valveOpening;
            valveLabel.innerText = data.valveOpening;
        }

        // 3. Grafico
        const now = new Date().toLocaleTimeString();
        levelChart.data.labels.push(now);
        levelChart.data.datasets[0].data.push(data.currentLevel);

        // Mantieni storico limitato
        if (levelChart.data.labels.length > MAX_HISTORY) {
            levelChart.data.labels.shift();
            levelChart.data.datasets[0].data.shift();
        }
        levelChart.update();
    }

    function setUnavailable() {
        badge.innerText = "NOT AVAILABLE (CUS OFF)";
        badge.className = "status-badge bg-not-avail";
        disableControls(true);
    }

    function disableControls(disabled) {
        slider.disabled = disabled;
        if(disabled) {
            sliderHelp.innerText = "Abilita MANUAL per controllare";
            sliderHelp.className = "text-muted d-block mt-2";
        } else {
            sliderHelp.innerText = "Trascina per regolare l'apertura";
            sliderHelp.className = "text-success fw-bold d-block mt-2";
        }
    }

    // --- AZIONI (API CALLS) ---
    async function toggleMode() {
        try { await fetch('/api/mode', { method: 'POST' }); } 
        catch (e) { console.error(e); }
    }

    async function updateValve(val) {
        try {
            await fetch('/api/valve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ valve: parseInt(val) })
            });
            valveLabel.innerText = val;
        } catch (e) { console.error(e); }
    }

    // Avvio loop
    setInterval(fetchData, 500);
    fetchData(); // Prima chiamata immediata

</script>
</body>
</html>